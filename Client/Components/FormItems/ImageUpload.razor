<LanguageTrackProvider OnInitializeEvent="provider => provider.RegisterComponent(this)" />

<MudStack Style="width: 100%; height: 100%;">
    <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                   AppendMultipleFiles=IsMultipleFiles
                   OnFilesChanged=OnInputFileChanged
                   Hidden=false Accept=".png, .jpeg, .jpg, .tiff, .bmp"
                   Class="d-block"
                   InputClass="absolute mud-width-full mud-height-full overflow-hidden z-20"
                   InputStyle="opacity:0"
                   Disabled=Disabled
                   Required=Required
                   @ondragenter=@SetDragClass
                   @ondragleave=@ClearDragClass
                   @ondragend=@ClearDragClass>
         <ButtonTemplate>
             <MudPaper Outlined="true"
                       Class="@_dragClass"
                       Style="overflow: hidden; height:90%;">
                <MudText Typo="Typo.h6" Class=@(Disabled ? "mud-text-disabled" : "")>
                    @Resource.DragDrop @(Label)
                    (Max size 10MB!)
                </MudText>
                @foreach (var image in IsMultipleFiles ? Files : Files.TakeLast(1))
                {
                    <MudPaper Class="pa-1 gap-1" Style="width: fit-content; height: fit-content;">
                        <MudImage Src=@image.Value Alt=@image.Key Height=50 Width=50 />
                        <MudText Typo=Typo.body2 Align=Align.Center>@image.Key</MudText>
                    </MudPaper>
                }
            </MudPaper>
        </ButtonTemplate>
    </MudFileUpload>
</MudStack>

@code {
    private const string DefaultDragClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full z-10";
    private string _dragClass = DefaultDragClass;

    [Parameter]
    public bool Disabled { get; set; } = false;
    [Parameter]
    public bool Required { get; set; } = false;
    [Parameter]
    public bool IsMultipleFiles { get; set; } = false;
    [Parameter]
    public string Label { get; set; } = string.Empty;
    [Parameter]
    public EventCallback<IEnumerable<IBrowserFile>> InputFilesChanged { get; set; }
    [Parameter]
    public Dictionary<string, string> Files { get; set; } = [];
    [Parameter]
    public EventCallback<Dictionary<string, string>> FilesChanged { get; set; }

    private async Task OnInputFileChanged(InputFileChangeEventArgs e)
    {
        ClearDragClass();
        var files = e.GetMultipleFiles().Where(i => i.Size <= 10485760);
        if (IsMultipleFiles)
        {
            foreach (var file in files)
            {
                Files.Add(file.Name, await file.ConvertStreamTobase64Async());
            }

        }
        else if (files.Any())
        {
            Files = new() { { files.First().Name, await files.First().ConvertStreamTobase64Async() } };
        }
        if (InputFilesChanged.HasDelegate) await InputFilesChanged.InvokeAsync(files);
        if (FilesChanged.HasDelegate) await FilesChanged.InvokeAsync(Files);
    }

    private void SetDragClass()
        => _dragClass = $"{DefaultDragClass} mud-border-primary";

    private void ClearDragClass()
        => _dragClass = DefaultDragClass;
}